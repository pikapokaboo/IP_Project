<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Archivist - Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>

<body class="page">
  <div class="game-wrap">
    <main class="game-card">
      <div class="game-meta">
        <div class="game-label">Object</div>
        <div id="gameObjectName" class="game-value">CAC-B04-312</div>
        <div class="game-label">Test</div>
        <div id="gameTestNumber" class="game-value">1</div>
      </div>

      <div class="game-actions">
        <button id="gamePassBtn" class="game-action game-pass" type="button">Pass</button>
        <button id="gameFailBtn" class="game-action game-fail" type="button">Fail</button>
      </div>
    </main>
  </div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const rawObject = (params.get("object") || "b04-312").toLowerCase();
      const objectMap = {
        "b04-312": "CAC-B04-312",
        "a17-049": "CAC-A17-049"
      };
      const MAX_TEST = 4;
      const TEST_PROGRESS_KEY = "testProgress";
      const FAIL_PROGRESS_KEY = "failProgress";
      const ACHIEVEMENTS_KEY = "achievementsProgress";

      function loadProgress() {
        try {
          const stored = localStorage.getItem(TEST_PROGRESS_KEY);
          return stored ? JSON.parse(stored) : {};
        } catch {
          return {};
        }
      }

      function saveProgress(progress) {
        localStorage.setItem(TEST_PROGRESS_KEY, JSON.stringify(progress));
      }

      function loadFailProgress() {
        try {
          const stored = localStorage.getItem(FAIL_PROGRESS_KEY);
          return stored ? JSON.parse(stored) : {};
        } catch {
          return {};
        }
      }

      function saveFailProgress(failProgress) {
        localStorage.setItem(FAIL_PROGRESS_KEY, JSON.stringify(failProgress));
      }

      function loadAchievements() {
        try {
          const stored = localStorage.getItem(ACHIEVEMENTS_KEY);
          return stored ? JSON.parse(stored) : {};
        } catch {
          return {};
        }
      }

      function saveAchievements(achievements) {
        localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(achievements));
      }

      const objectKey = objectMap[rawObject] ? rawObject : "b04-312";
      const progress = loadProgress();
      const testNumber = Number(progress[objectKey]) || 1;
      const objectName = objectMap[objectKey];

      const objectEl = document.getElementById("gameObjectName");
      const testEl = document.getElementById("gameTestNumber");
      const passBtn = document.getElementById("gamePassBtn");
      const failBtn = document.getElementById("gameFailBtn");

      if (objectEl) objectEl.textContent = objectName;
      if (testEl) testEl.textContent = String(testNumber);

      function goHome() {
        sessionStorage.setItem("skipHomeIntro", "true");
        window.location.href = "home.html?skipHomeIntro=1";
      }

      function updateAchievementsOnPass(currentTest, currentObject) {
        const achievements = loadAchievements();
        if (!achievements.clockingOut) achievements.clockingOut = true;
        if (currentObject === "b04-312" && currentTest >= 4) achievements.digitallyTraditional = true;
        if (currentObject === "a17-049" && currentTest >= 4) achievements.rollCamera = true;
        if (achievements.digitallyTraditional && achievements.rollCamera) {
          achievements.congratulations = true;
        }
        saveAchievements(achievements);
      }

      function updateAchievementsOnFail(currentObject) {
        const achievements = loadAchievements();
        if (currentObject === "b04-312" && !achievements.stomachKnowledge) {
          achievements.stomachKnowledge = true;
        }
        if (currentObject === "a17-049" && !achievements.intoNewWorld) {
          achievements.intoNewWorld = true;
        }
        saveAchievements(achievements);
      }

      if (passBtn) {
        passBtn.addEventListener("click", () => {
          if (testNumber >= MAX_TEST) {
            progress[objectKey] = MAX_TEST + 1;
          } else {
            const next = Math.min(MAX_TEST, testNumber + 1);
            progress[objectKey] = next;
          }
          saveProgress(progress);
          updateAchievementsOnPass(testNumber, objectKey);
          goHome();
        });
      }

      if (failBtn) {
        failBtn.addEventListener("click", () => {
          progress[objectKey] = testNumber;
          saveProgress(progress);
          const failProgress = loadFailProgress();
          const objectFails = failProgress[objectKey] || {};
          const currentFails = Number(objectFails[testNumber]) || 0;
          objectFails[testNumber] = Math.min(5, currentFails + 1);
          failProgress[objectKey] = objectFails;
          saveFailProgress(failProgress);
          updateAchievementsOnFail(objectKey);
          goHome();
        });
      }
    })();
  </script>
</body>
</html>
